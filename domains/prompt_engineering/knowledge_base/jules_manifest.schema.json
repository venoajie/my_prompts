{
  "operations": [
    {
      "operation": "CREATE_FILE",
      "path": "docker-compose.yml",
      "content": "services:\n  redis:\n    image: redis/redis-stack:7.2.0-v7\n    profiles:  [\"full\", \"receiver\", \"distributor\", \"janitor\", \"executor\", \"backfill\", \"analyzer\"]\n    networks: [trading-net]\n    healthcheck:\n      test: [\"CMD-SHELL\", \"redis-cli PING | grep PONG\"]\n      interval: 5s\n      timeout: 3s\n      retries: 10\n      start_period: 20s\n\n  postgres:\n    image: postgres:17\n    profiles:  [\"full\", \"receiver\", \"distributor\", \"janitor\", \"executor\", \"backfill\", \"analyzer\"]\n    environment:\n      POSTGRES_USER: trading_app\n      POSTGRES_DB: trading\n    volumes:\n      - pgdata:/var/lib/postgresql/data\n      - ./init.sql:/docker-entrypoint-initdb.d/init.sql\n    secrets: [db_password]\n    networks: [trading-net]\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U trading_app -d trading\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n\n  janitor:\n    profiles: [\"full\", \"janitor\"]\n    build:\n      context: .\n      dockerfile: src/services/janitor/Dockerfile\n      args:\n        - BUILDPLATFORM=linux/arm64\n    env_file: ./.env\n    environment:\n      - SERVICE_NAME=janitor\n      - REDIS_URL=redis://redis:6379\n      - POSTGRES_HOST=postgres\n      - POSTGRES_USER=trading_app\n      - POSTGRES_DB=trading\n    secrets:\n      - db_password\n      - source: deribit_client_id\n        target: deribit_client_id\n      - source: deribit_client_secret\n        target: deribit_client_secret\n    depends_on:\n      redis: { condition: service_healthy }\n      postgres: { condition: service_healthy }\n    networks: [trading-net]\n\n  analyzer:\n    profiles: [\"full\", \"analyzer\"]\n    build:\n      context: .\n      dockerfile: src/services/analyzer/Dockerfile\n      args:\n        - BUILDPLATFORM=linux/arm64\n    env_file: ./.env\n    environment:\n      - SERVICE_NAME=analyzer\n      - REDIS_URL=redis://redis:6379\n      - POSTGRES_HOST=postgres\n      - POSTGRES_USER=trading_app\n      - POSTGRES_DB=trading\n    secrets: [db_password]\n    depends_on:\n      janitor: { condition: service_completed_successfully }\n    networks: [trading-net]\n\n  backfill:\n    profiles: [\"full\", \"backfill\"]\n    build:\n      context: .\n      dockerfile: src/services/backfill/Dockerfile\n      args:\n        - BUILDPLATFORM=linux/arm64\n    env_file: ./.env\n    environment:\n      - SERVICE_NAME=backfill\n      - REDIS_URL=redis://redis:6379\n      - POSTGRES_HOST=postgres\n      - POSTGRES_USER=trading_app\n      - POSTGRES_DB=trading\n    secrets: [db_password]\n    depends_on:\n      janitor: { condition: service_completed_successfully }\n    networks: [trading-net]\n\n  distributor:\n    profiles: [\"full\", \"distributor\"]\n    build:\n      context: .\n      dockerfile: src/services/distributor/Dockerfile\n      args:\n        - BUILDPLATFORM=linux/arm64\n    env_file: ./.env\n    environment:\n      - SERVICE_NAME=distributor\n      - REDIS_URL=redis://redis:6379\n      - POSTGRES_HOST=postgres\n      - POSTGRES_USER=trading_app\n      - POSTGRES_DB=trading\n    secrets: [db_password]\n    depends_on:\n      janitor: { condition: service_completed_successfully }\n    networks: [trading-net]\n\n  executor:\n    profiles: [\"full\", \"executor\"]\n    build:\n      context: .\n      dockerfile: src/services/executor/Dockerfile\n      args:\n        - BUILDPLATFORM=linux/arm64\n    env_file: ./.env\n    environment:\n      - SERVICE_NAME=executor\n      - REDIS_URL=redis://redis:6379\n      - POSTGRES_HOST=postgres\n      - POSTGRES_USER=trading_app\n      - POSTGRES_DB=trading\n    secrets:\n      - db_password\n      - source: deribit_client_id\n        target: deribit_client_id\n      - source: deribit_client_secret\n        target: deribit_client_secret\n    depends_on:\n      janitor: { condition: service_completed_successfully }\n    networks: [trading-net]\n\n  receiver:\n    profiles: [\"full\", \"receiver\"]\n    build:\n      context: .\n      dockerfile: src/services/receiver/Dockerfile\n      args:\n        - BUILDPLATFORM=linux/arm64\n    env_file: ./.env\n    environment:\n      - SERVICE_NAME=receiver\n      - REDIS_URL=redis://redis:6379\n      - POSTGRES_HOST=postgres\n      - POSTGRES_USER=trading_app\n      - POSTGRES_DB=trading\n    secrets:\n      - db_password\n      - source: deribit_client_id\n        target: deribit_client_id\n      - source: deribit_client_secret\n        target: deribit_client_secret\n    depends_on:\n      janitor: { condition: service_completed_successfully }\n    networks: [trading-net]\n\nvolumes:\n  redis-data:\n    driver: local\n    driver_opts:\n      type: none\n      o: bind\n      device: /data/volumes/redis-data\n  pgdata:\n    driver: local\n    driver_opts:\n      type: none\n      o: bind\n      device: /data/volumes/pgdata\n\nsecrets:\n  db_password:\n    file: ./secrets/db_password.txt\n  deribit_client_id:\n    file: ./secrets/client_id.txt\n  deribit_client_secret:\n    file: ./secrets/client_secret.txt\n\nnetworks:\n  trading-net:\n    driver: bridge\n    driver_opts:\n      com.docker.network.bridge.name: trading-br\n    ipam:\n      config:\n        - subnet: 172.20.0.0/16"
    },
    {
      "operation": "CREATE_FILE",
      "path": "docker-compose.dev.yml",
      "content": "services:\n  redis:\n    ports: [\"6380:6379\", \"8001:8001\"]\n    command:\n      - redis-server\n      - \"--bind 0.0.0.0\"\n      - \"--protected-mode no\"\n    mem_limit: 800m\n    mem_reservation: 600m\n\n  postgres:\n    ports: [\"5432:5432\"]\n    # For development, use a simple password instead of secrets\n    environment:\n      POSTGRES_PASSWORD: \"devpassword\"\n    # Secrets block must be cleared to prevent compose from looking for the file\n    secrets: []\n    command:\n      - \"-c\"\n      - \"max_connections=50\" # Lower for dev\n    mem_limit: 800m\n    mem_reservation: 512m\n\n  janitor:\n    environment: { POSTGRES_PASSWORD: \"devpassword\" }\n    secrets: []\n    restart: on-failure\n    mem_limit: 200m\n    mem_reservation: 100m\n\n  analyzer:\n    environment: { POSTGRES_PASSWORD: \"devpassword\" }\n    secrets: []\n    restart: on-failure\n    mem_limit: 256m\n    mem_reservation: 128m\n\n  backfill:\n    environment: { POSTGRES_PASSWORD: \"devpassword\" }\n    secrets: []\n    restart: on-failure\n    mem_limit: 256m\n    mem_reservation: 128m\n\n  distributor:\n    environment: { POSTGRES_PASSWORD: \"devpassword\" }\n    secrets: []\n    restart: on-failure\n    mem_limit: 384m\n    mem_reservation: 256m\n\n  executor:\n    environment: { POSTGRES_PASSWORD: \"devpassword\" }\n    secrets: []\n    restart: on-failure\n    mem_limit: 256m\n    mem_reservation: 128m\n\n  receiver:\n    environment: { POSTGRES_PASSWORD: \"devpassword\" }\n    secrets: []\n    restart: on-failure\n    mem_limit: 384m\n    mem_reservation: 256m"
    },
    {
      "operation": "CREATE_FILE",
      "path": "docker-compose.prod.yml",
      "content": "services:\n  redis:\n    volumes:\n      - redis-data:/data\n      - ./config/redis.prod.conf:/usr/local/etc/redis/redis.conf:ro\n    command: redis-server /usr/local/etc/redis/redis.conf\n    restart: unless-stopped\n    deploy:\n      resources:\n        limits:\n          memory: 800m\n          cpus: '0.5'\n        reservations:\n          memory: 600m\n          cpus: '0.25'\n    sysctls:\n      - net.core.somaxconn=65535\n    ulimits:\n      memlock:\n        soft: -1\n        hard: -1\n\n  postgres:\n    environment:\n      POSTGRES_PASSWORD_FILE: /run/secrets/db_password\n      POSTGRES_INITDB_ARGS: \"--encoding=UTF8 --data-checksums\"\n    volumes:\n      - pgdata:/var/lib/postgresql/data\n      - ./init.sql:/docker-entrypoint-initdb.d/init.sql\n      - ./config/postgresql.prod.conf:/etc/postgresql/postgresql.conf:ro\n    command: postgres -c config_file=/etc/postgresql/postgresql.conf\n    restart: unless-stopped\n    deploy:\n      resources:\n        limits:\n          memory: 1g\n          cpus: '1.0'\n        reservations:\n          memory: 768m\n          cpus: '0.5'\n    shm_size: 256m\n\n  janitor:\n    environment: { POSTGRES_PASSWORD_FILE: /run/secrets/db_password }\n    restart: on-failure\n    deploy:\n      resources:\n        limits: { memory: 200m, cpus: '0.2' }\n        reservations: { memory: 100m, cpus: '0.1' }\n\n  analyzer:\n    environment: { POSTGRES_PASSWORD_FILE: /run/secrets/db_password }\n    restart: unless-stopped\n    deploy:\n      resources:\n        limits: { memory: 256m, cpus: '0.25' }\n        reservations: { memory: 128m, cpus: '0.1' }\n\n  backfill:\n    environment: { POSTGRES_PASSWORD_FILE: /run/secrets/db_password }\n    restart: unless-stopped\n    deploy:\n      resources:\n        limits: { memory: 256m, cpus: '0.25' }\n        reservations: { memory: 128m, cpus: '0.1' }\n\n  distributor:\n    environment: { POSTGRES_PASSWORD_FILE: /run/secrets/db_password }\n    restart: unless-stopped\n    deploy:\n      resources:\n        limits: { memory: 384m, cpus: '0.4' }\n        reservations: { memory: 256m, cpus: '0.2' }\n\n  executor:\n    environment: { POSTGRES_PASSWORD_FILE: /run/secrets/db_password }\n    restart: unless-stopped\n    deploy:\n      resources:\n        limits: { memory: 256m, cpus: '0.25' }\n        reservations: { memory: 128m, cpus: '0.1' }\n\n  receiver:\n    environment: { POSTGRES_PASSWORD_FILE: /run/secrets/db_password }\n    restart: unless-stopped\n    deploy:\n      resources:\n        limits: { memory: 384m, cpus: '0.4' }\n        reservations: { memory: 256m, cpus: '0.2' }"
    },
    {
      "operation": "CREATE_FILE",
      "path": "config/redis.prod.conf",
      "content": "# Redis configuration optimized for A1.Flex\nbind 0.0.0.0\nprotected-mode no\nport 6379\n\n# Memory\nmaxmemory 600mb\nmaxmemory-policy noeviction\n\n# Persistence\nsave 900 1\nsave 300 10\nsave 60 10000\nstop-writes-on-bgsave-error yes\nrdbcompression yes\nrdbchecksum yes\n\n# Performance\nio-threads 2\nio-threads-do-reads yes\n\n# Disable huge pages warning\ndisable-thp yes\n\n# ARM-specific\nactiverehashing yes\nhz 10\n\n# Logging\nloglevel notice\nlogfile \"\""
    },
    {
      "operation": "CREATE_FILE",
      "path": "config/postgresql.prod.conf",
      "content": "# PostgreSQL optimized for A1.Flex with 18GB RAM\n# General Settings\nlisten_addresses = '*'\nmax_connections = 100\njit = off # Aligned with application client setting\n\n# Memory (for ~1GB allocated to PG)\nshared_buffers = 256MB\neffective_cache_size = 768MB\nwork_mem = 4MB\nmaintenance_work_mem = 64MB\n\n# Storage/Checkpoint\ncheckpoint_completion_target = 0.9\nwal_buffers = 16MB\ndefault_statistics_target = 100\nrandom_page_cost = 1.1\neffective_io_concurrency = 200\nmax_worker_processes = 3\nmax_parallel_workers_per_gather = 1\nmax_parallel_workers = 2\n\n# Logging\nlog_destination = 'stderr'\nlogging_collector = off\nlog_min_duration_statement = 1000\nlog_timezone = 'UTC'\n\n# ARM optimization\nhuge_pages = off"
    },
    {
      "operation": "CREATE_FILE",
      "path": "scripts/optimize-system.sh",
      "content": "#!/bin/bash\n# System optimizations for A1.Flex trading system\n\necho \"Applying system-level optimizations for trading workload...\"\n\n# Increase file descriptors\necho \"Updating file descriptor limits in /etc/security/limits.conf...\"\nsudo tee -a /etc/security/limits.conf > /dev/null << EOF\n* soft nofile 65535\n* hard nofile 65535\nEOF\n\n# Kernel parameters for trading/database workload\necho \"Updating kernel parameters in /etc/sysctl.conf...\"\nsudo tee -a /etc/sysctl.conf > /dev/null << EOF\n\n# Network optimizations for high-throughput trading\nnet.core.rmem_max = 134217728\nnet.core.wmem_max = 134217728\nnet.ipv4.tcp_rmem = 4096 87380 134217728\nnet.ipv4.tcp_wmem = 4096 65536 134217728\nnet.core.netdev_max_backlog = 5000\nnet.ipv4.tcp_congestion_control = bbr\nnet.core.default_qdisc = fq\n\n# Memory optimizations\nvm.swappiness = 10\nvm.dirty_ratio = 15\nvm.dirty_background_ratio = 5\nvm.overcommit_memory = 1\n\n# File system limits\nfs.file-max = 2097152\nfs.inotify.max_user_watches = 524288\nEOF\n\necho \"Applying new kernel parameters...\"\nsudo sysctl -p\n\n# Setup swap on block volume (useful for memory spikes)\nif [ -f \"/data/swapfile\" ]; then\n    echo \"Swapfile already exists. Skipping creation.\"\nelse\n    echo \"Creating 4GB swapfile on /data/swapfile...\"\n    sudo dd if=/dev/zero of=/data/swapfile bs=1G count=4\n    sudo chmod 600 /data/swapfile\n    sudo mkswap /data/swapfile\n    sudo swapon /data/swapfile\n    echo \"/data/swapfile none swap sw 0 0\" | sudo tee -a /etc/fstab\nfi\n\necho \"✓ System optimization complete.\""
    },
    {
      "operation": "CREATE_FILE",
      "path": "Makefile",
      "content": "# =====================================================================\n# Universal Makefile for OCI Block Volume Setup + Trading System Deploy\n# =====================================================================\n# Works on: Oracle Linux 9, Ubuntu 24, Ubuntu 22.04\n# Purpose: Automate block volume setup and trading system deployment\n# Author: Trading System DevOps\n# =====================================================================\n\n# OS Detection and Environment Setup\nOS_NAME := $(shell grep '^ID=' /etc/os-release | cut -d'=' -f2 | tr -d '\"')\nOS_VERSION := $(shell grep '^VERSION_ID=' /etc/os-release | cut -d'=' -f2 | tr -d '\"')\nHOSTNAME := $(shell hostname)\nTIMESTAMP := $(shell date +%Y%m%d-%H%M%S)\n\n# OS-specific Configuration\nifeq ($(OS_NAME),ol)\n    # Oracle Linux settings\n    DEFAULT_USER = opc\n    DEFAULT_GROUP = opc\n    SUDO_GROUP = wheel\n    SELINUX_ENABLED = true\n    PACKAGE_MANAGER = dnf\nelse ifeq ($(OS_NAME),ubuntu)\n    # Ubuntu settings\n    DEFAULT_USER = ubuntu\n    DEFAULT_GROUP = ubuntu\n    SUDO_GROUP = sudo\n    SELINUX_ENABLED = false\n    PACKAGE_MANAGER = apt-get\nelse\n    # Generic Linux settings\n    DEFAULT_USER = $(shell whoami)\n    DEFAULT_GROUP = $(shell whoami)\n    SUDO_GROUP = sudo\n    SELINUX_ENABLED = false\n    PACKAGE_MANAGER = apt-get\nendif\n\n# Block Volume Configuration Variables\nMOUNT_POINT = /data\nVOLUME_OWNER = $(DEFAULT_USER):$(DEFAULT_GROUP)\nFILESYSTEM_TYPE = ext4\nDOCKER_DATA_DIR = $(MOUNT_POINT)/docker\nTRADING_APP_DIR = $(MOUNT_POINT)/trading-app\nBACKUP_DIR = $(MOUNT_POINT)/backups\n\n# Auto-detected Block Device Variables\nDEVICE := $(shell lsblk -rno NAME,TYPE | grep disk | grep -v -E 'sda|vda' | awk '{print \"/dev/\"$$1}' | head -1)\nPARTITION := $(DEVICE)1\nUUID := $(shell sudo blkid $(PARTITION) 2>/dev/null | grep -o 'UUID=\"[^\"]*\"' | cut -d'\"' -f2)\n\n# Trading System Configuration\nTRADING_REPO_URL = https://github.com/your-org/trading-system.git\nTRADING_BRANCH = main\nCURRENCY_TO_BOOTSTRAP = BTC\nCOMPOSE_BASE_FILE = docker-compose.yml\nCOMPOSE_DEV_OVERRIDE = docker-compose.dev.yml\nCOMPOSE_PROD_OVERRIDE = docker-compose.prod.yml\n\n# ANSI Color codes for pretty output\nGREEN = \\033[0;32m\nYELLOW = \\033[1;33m\nRED = \\033[0;31m\nBLUE = \\033[0;34m\nMAGENTA = \\033[0;35m\nCYAN = \\033[0;36m\nWHITE = \\033[1;37m\nNC = \\033[0m # No Color\n\n# Default target when just running 'make'\n.DEFAULT_GOAL := help\n\n# =======================\n# HELP AND DOCUMENTATION\n# =======================\n.PHONY: help\nhelp:\n\t@echo \"$(BLUE)================================================================$(NC)\"\n\t@echo \"$(WHITE)   OCI Block Volume + Trading System Setup Makefile$(NC)\"\n\t@echo \"$(BLUE)================================================================$(NC)\"\n\t@echo \"\"\n\t@echo \"$(CYAN)System Information:$(NC)\"\n\t@echo \"  OS Detected    : $(GREEN)$(OS_NAME) $(OS_VERSION)$(NC)\"\n\t@echo \"  Hostname       : $(GREEN)$(HOSTNAME)$(NC)\"\n\t@echo \"  Default User   : $(GREEN)$(DEFAULT_USER)$(NC)\"\n\t@echo \"  Block Device   : $(GREEN)$(or $(DEVICE),NOT FOUND - Attach volume first!)$(NC)\"\n\t@echo \"  Mount Point    : $(GREEN)$(MOUNT_POINT)$(NC)\"\n\t@echo \"\"\n\t@echo \"$(CYAN)Quick Start Commands:$(NC)\"\n\t@echo \"  $(GREEN)make complete-setup$(NC)     - Run full setup (volume + trading system)\"\n\t@echo \"  $(GREEN)make volume-setup$(NC)       - Setup block volume only\"\n\t@echo \"  $(GREEN)make trading-setup$(NC)      - Setup trading system only\"\n\t@echo \"\"\n\t@echo \"$(MAGENTA)TRADING SYSTEM COMMANDS (ENVIRONMENT-AWARE)$(NC)\"\n\t@echo \"  $(GREEN)make deploy$(NC)             - Smart deploy (detects prod/dev from hostname)\"\n\t@echo \"  $(GREEN)make dev-up$(NC)              - Start development environment\"\n\t@echo \"  $(GREEN)make dev-down$(NC)            - Stop development environment\"\n\t@echo \"  $(GREEN)make prod-up$(NC)             - Start production environment\"\n\t@echo \"  $(GREEN)make prod-down$(NC)           - Stop production environment\"\n\t@echo \"\"\n\t@echo \"$(CYAN)Block Volume Commands:$(NC)\"\n\t@echo \"  $(GREEN)make check$(NC)              - Check current disk status\"\n\t@echo \"  $(GREEN)make setup$(NC)              - Create partition on block device\"\n\t@echo \"  $(GREEN)make format$(NC)             - Format the volume ($(RED)DESTROYS DATA!$(NC))\"\n\t@echo \"\"\n\t@echo \"$(CYAN)Trading System Commands (Legacy):$(NC)\"\n\t@echo \"  $(GREEN)make install-docker$(NC)     - Install Docker and Docker Compose\"\n\t@echo \"  $(GREEN)make trading-deploy$(NC)     - Deploy trading application (legacy)\"\n\t@echo \"\"\n\t@echo \"$(YELLOW)For detailed help on any command, run: make help-<command>$(NC)\"\n\t@echo \"$(BLUE)================================================================$(NC)\"\n\n# =======================\n# COMPLETE SETUP TARGETS\n# =======================\n.PHONY: complete-setup volume-setup trading-setup\n\ncomplete-setup:\n\t@echo \"$(BLUE)================================================================$(NC)\"\n\t@echo \"$(WHITE)         Complete OCI Instance Setup Starting...$(NC)\"\n\t@echo \"$(BLUE)================================================================$(NC)\"\n\t@$(MAKE) volume-setup\n\t@echo \"\"\n\t@$(MAKE) install-docker\n\t@echo \"\"\n\t@$(MAKE) trading-setup\n\t@echo \"\"\n\t@echo \"$(GREEN)✓ Complete setup finished successfully!$(NC)\"\n\t@echo \"$(YELLOW)Next step: run 'make deploy' to start the application.$(NC)\"\n\nvolume-setup: check setup format mount permanent selinux-fix test create-directories\n\t@echo \"$(GREEN)✓ Block volume setup complete!$(NC)\"\n\ntrading-setup: check-docker trading-deploy\n\t@echo \"$(GREEN)✓ Trading system setup complete!$(NC)\"\n\n# =======================================\n# TRADING SYSTEM COMMANDS (ENVIRONMENT-AWARE)\n# =======================================\n.PHONY: deploy dev-up dev-down prod-up prod-down\n\ndeploy:\n\t@echo \"$(YELLOW)=== Smart Deploying Application ===$(NC)\"\n\t@if echo \"$(HOSTNAME)\" | grep -qiE \"prod|prd\"; then \\\n\t\techo \"$(MAGENTA)Production hostname detected. Deploying production stack...$(NC)\"; \\\n\t\t$(MAKE) prod-up; \\\n\telse \\\n\t\techo \"$(CYAN)Development hostname detected. Deploying development stack...$(NC)\"; \\\n\t\t$(MAKE) dev-up; \\\n\tfi\n\ndev-up:\n\t@echo \"$(CYAN)Starting development environment...$(NC)\"\n\tdocker compose -f $(COMPOSE_BASE_FILE) -f $(COMPOSE_DEV_OVERRIDE) up -d --remove-orphans\n\ndev-down:\n\t@echo \"$(CYAN)Stopping development environment...$(NC)\"\n\tdocker compose -f $(COMPOSE_BASE_FILE) -f $(COMPOSE_DEV_OVERRIDE) down\n\nprod-up:\n\t@echo \"$(MAGENTA)Starting PRODUCTION environment...$(NC)\"\n\tdocker compose -f $(COMPOSE_BASE_FILE) -f $(COMPOSE_PROD_OVERRIDE) up -d --remove-orphans\n\nprod-down:\n\t@echo \"$(MAGENTA)Stopping PRODUCTION environment...$(NC)\"\n\tdocker compose -f $(COMPOSE_BASE_FILE) -f $(COMPOSE_PROD_OVERRIDE) down\n\n# =======================\n# BLOCK VOLUME OPERATIONS\n# =======================\n\n.PHONY: check\ncheck:\n\t@echo \"$(YELLOW)=== Checking System Status ===$(NC)\"\n\t@echo \"$(CYAN)Available block devices:$(NC)\"\n\t@lsblk -f\n\t@echo \"\"\n\t@echo \"$(CYAN)Current disk usage:$(NC)\"\n\t@df -h | grep -E \"^/dev|^Filesystem\" | grep -v tmpfs\n\t@echo \"\"\n\t@if [ -z \"$(DEVICE)\" ]; then \\\n\t\techo \"$(RED)ERROR: No additional block device found!$(NC)\"; \\\n\t\techo \"$(YELLOW)Please attach a block volume in OCI Console first.$(NC)\"; \\\n\t\techo \"\"; \\\n\t\techo \"$(CYAN)Detected devices:$(NC)\"; \\\n\t\tlsblk -d -o NAME,SIZE,TYPE,MOUNTPOINT | grep -v loop; \\\n\t\texit 1; \\\n\telse \\\n\t\techo \"$(GREEN)✓ Found device: $(DEVICE)$(NC)\"; \\\n\t\techo \"$(CYAN)Device details:$(NC)\"; \\\n\t\tsudo fdisk -l $(DEVICE) 2>/dev/null | grep -E \"^Disk|^Device\"; \\\n\tfi\n\n.PHONY: setup\nsetup: check\n\t@echo \"$(YELLOW)=== Setting up Block Volume ===$(NC)\"\n\t@echo \"$(CYAN)This will prepare $(GREEN)$(DEVICE)$(NC) for use as a data volume$(NC)\"\n\t@echo \"\"\n\t@if [ -e $(PARTITION) ]; then \\\n\t\techo \"$(YELLOW)⚠ Partition $(PARTITION) already exists$(NC)\"; \\\n\t\techo \"$(CYAN)Current partition table:$(NC)\"; \\\n\t\tsudo fdisk -l $(DEVICE) | grep ^$(DEVICE); \\\n\telse \\\n\t\techo \"$(RED)WARNING: This will create a new partition table on $(DEVICE)!$(NC)\"; \\\n\t\techo \"$(YELLOW)All data on this device will be lost!$(NC)\"; \\\n\t\tread -p \"Are you sure you want to continue? [y/N] \" confirm && [ \"$$confirm\" = \"y\" ] || exit 1; \\\n\t\techo \"\"; \\\n\t\techo \"$(CYAN)Creating partition...$(NC)\"; \\\n\t\techo -e \"n\\np\\n1\\n\\n\\nw\" | sudo fdisk $(DEVICE) > /dev/null 2>&1 || \\\n\t\t\t(echo -e \"g\\nn\\n1\\n\\n\\nw\" | sudo fdisk $(DEVICE) > /dev/null 2>&1); \\\n\t\tsleep 2; \\\n\t\tsudo partprobe $(DEVICE) 2>/dev/null || true; \\\n\t\techo \"$(GREEN)✓ Partition created successfully$(NC)\"; \\\n\t\techo \"$(CYAN)New partition table:$(NC)\"; \\\n\t\tsudo fdisk -l $(DEVICE) | grep ^$(DEVICE); \\\n\tfi\n\n.PHONY: format\nformat: check\n\t@echo \"$(YELLOW)=== Formatting Block Volume ===$(NC)\"\n\t@if [ -e $(PARTITION) ]; then \\\n\t\tif sudo blkid $(PARTITION) > /dev/null 2>&1; then \\\n\t\t\techo \"$(YELLOW)⚠ WARNING: $(PARTITION) already contains a filesystem!$(NC)\"; \\\n\t\t\techo \"$(CYAN)Current filesystem info:$(NC)\"; \\\n\t\t\tsudo blkid $(PARTITION); \\\n\t\t\techo \"\"; \\\n\t\t\techo \"$(RED)ALL DATA ON THIS PARTITION WILL BE PERMANENTLY DELETED!$(NC)\"; \\\n\t\t\tread -p \"Are you absolutely sure you want to format? Type 'yes' to continue: \" confirm && [ \"$$confirm\" = \"yes\" ] || exit 1; \\\n\t\tfi; \\\n\t\techo \"\"; \\\n\t\techo \"$(CYAN)Formatting $(PARTITION) as $(FILESYSTEM_TYPE)...$(NC)\"; \\\n\t\tsudo mkfs.$(FILESYSTEM_TYPE) -F -L \"OCI-DATA\" $(PARTITION); \\\n\t\tsync; \\\n\t\techo \"$(GREEN)✓ Formatted successfully$(NC)\"; \\\n\t\techo \"$(CYAN)New filesystem info:$(NC)\"; \\\n\t\tsudo blkid $(PARTITION); \\\n\telse \\\n\t\techo \"$(RED)ERROR: Partition $(PARTITION) not found!$(NC)\"; \\\n\t\techo \"$(YELLOW)Run 'make setup' first to create the partition$(NC)\"; \\\n\t\texit 1; \\\n\tfi\n\n.PHONY: mount\nmount:\n\t@echo \"$(YELLOW)=== Mounting Block Volume ===$(NC)\"\n\t@if [ ! -d $(MOUNT_POINT) ]; then \\\n\t\techo \"$(CYAN)Creating mount point $(MOUNT_POINT)...$(NC)\"; \\\n\t\tsudo mkdir -p $(MOUNT_POINT); \\\n\tfi\n\t@if mountpoint -q $(MOUNT_POINT); then \\\n\t\techo \"$(YELLOW)⚠ $(MOUNT_POINT) is already mounted$(NC)\"; \\\n\t\tmount | grep $(MOUNT_POINT); \\\n\telse \\\n\t\techo \"$(CYAN)Mounting $(PARTITION) to $(MOUNT_POINT)...$(NC)\"; \\\n\t\tsudo mount $(PARTITION) $(MOUNT_POINT); \\\n\t\tsudo chown $(VOLUME_OWNER) $(MOUNT_POINT); \\\n\t\techo \"$(GREEN)✓ Mounted successfully$(NC)\"; \\\n\t\techo \"$(CYAN)Mount details:$(NC)\"; \\\n\t\tmount | grep $(MOUNT_POINT); \\\n\tfi\n\n.PHONY: permanent\npermanent:\n\t@echo \"$(YELLOW)=== Making Mount Permanent ===$(NC)\"\n\t@# Refresh UUID after format\n\t$("
    },
    {
      "operation": "CREATE_FILE",
      "path": "system_config/etc/docker/daemon.json",
      "content": "{\n  \"data-root\": \"/data/docker\",\n  \"storage-driver\": \"overlay2\",\n  \"storage-opts\": [\n    \"overlay2.override_kernel_check=true\"\n  ],\n  \"log-driver\": \"json-file\",\n  \"log-opts\": {\n    \"max-size\": \"10m\",\n    \"max-file\": \"3\",\n    \"compress\": \"true\"\n  },\n  \"default-ulimits\": {\n    \"memlock\": {\n      \"Name\": \"memlock\",\n      \"Hard\": -1,\n      \"Soft\": -1\n    }\n  },\n  \"live-restore\": true,\n  \"userland-proxy\": false,\n  \"ip-forward\": true,\n  \"iptables\": true\n}"
    }
  ]
}